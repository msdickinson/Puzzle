<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title></title>
    <link href="css/main.css" rel="stylesheet" />
    <link href="css/pure.css" rel="stylesheet" />
    <script src="script/lib/pixi.js"></script>
    <script src="script/lib/mainloop.js"></script>
    <script src="script/lib/howler.js"></script>
    <script src="script/lib/jszip.js"></script>
</head>
<body>
    <div id="Loading" class="loading">
        <center>
            <div class="loader"></div>

        </center>
    </div>
    <div id="Game">
        <div class="pure-form">
            <fieldset>
                <input id="Ticks" type="number" step="1" min="1" max="10000" value="1" style="width: 235px">
                <button onclick="ApplyTicks()" class="pure-button pure-button-primary">Ticks</button>
            </fieldset>
        </div>
    </div>

    <div class="pure-table pure-table-bordered" style="
    margin: 20px;
    background-color: floralwhite">

        <table>
            <caption>Game</caption>
            <thead>
                <tr>
                    <th>Property</th>
                    <th>Tick</th>
                </tr>
            </thead>
            <tr>
                <td>Game</td>
                <td id="GamePuzzleActive"></td>
            </tr>
            <tr>
                <td>Hovering</td>
                <td id="GameHoverActive"></td>
            </tr>
            <tr>
                <td>Swaping</td>
                <td id="GameSwapActive"></td>
            </tr>
            <tr>
                <td>Removing</td>
                <td id="GameBlocksRemovingActive"></td>
            </tr>
            <tr>
                <td>Falling</td>
                <td id="GameFallingActive"></td>
            </tr>
            <tr>
                <td>Ticks To Hover</td>
                <td id="GameTicksToHover"></td>
            </tr>
            <tr>
                <td>Ticks To Hover Swap</td>
                <td id="GameTicksToHoverSwap"></td>
            </tr>
            <tr>
                <td>Ticks To Fall</td>
                <td id="GameTicksToFall"></td>
            </tr>
            <tr>
                <td>Ticks To Remove</td>
                <td id="GameTicksToRemove"></td>
            </tr>
            <tr>
                <td>Ticks</td>
                <td id="GameTicks"></td>
            </tr>
            <tr>
                <td>New Row</td>
                <td id="GameNewRow"></td>
            </tr>
            <tr>
                <td>Swap</td>
                <td id="GameSwap"></td>
            </tr>

        </table>


    </div>
    <div class="pure-table pure-table-bordered" style="
    margin: 20px;
    background-color: floralwhite" >


    <table>
        <caption>Left Block</caption>
        <thead>
            <tr>
                <th>Property</th>
                <th>Value</th>
            </tr>
        </thead>
        <tr>
            <td>Color</td>
            <td id="LeftBlockColor"></td>
        </tr>
        <tr>
            <td>State</td>
            <td id="LeftBlockState"></td>
        </tr>
        <tr>
            <td>TotalChain</td>
            <td id="LeftBlockTotalChain"></td>
        </tr>
        <tr>
            <td>Tick</td>
            <td id="LeftBlockTick"></td>
        </tr>
        <tr>
            <td>FallGroup Ticks</td>
            <td id="LeftBlockFallGroupTicks"></td>
        </tr>
        <tr>
            <td>GroupId</td>
            <td id="LeftBlockGroupId"></td>
        </tr>
    </table>


    </div>
    <div class="pure-table pure-table-bordered" style="
    margin: 20px;
    background-color: floralwhite">

    <table>
        <caption>Right Block</caption>
        <thead>
            <tr>
                <th>Property</th>
                <th>Value</th>
            </tr>
        </thead>
        <tr>
            <td>Color</td>
            <td id="RightBlockColor"></td>
        </tr>
        <tr>
            <td>State</td>
            <td id="RightBlockState"></td>
        </tr>
        <tr>
            <td>TotalChain</td>
            <td id="RightBlockTotalChain"></td>
        </tr>
        <tr>
            <td>Tick</td>
            <td id="RightBlockTick"></td>
        </tr>
        <tr>
            <td>FallGroup Ticks</td>
            <td id="RightBlockFallGroupTicks"></td>
        </tr>
        <tr>
            <td>GroupId</td>
            <td id="RightBlockGroupId"></td>
        </tr>
    </table>


    </div>
    <!--<!--{"Color":4,"State":1,"TotalChain":0,"Tick":0,"FallGroupTicks":0,"groupId":0},-->
    <script>
        (function () { var script = document.createElement('script'); script.onload = function () { var stats = new Stats(); document.body.appendChild(stats.dom); requestAnimationFrame(function loop() { stats.update(); requestAnimationFrame(loop) }); }; script.src = '//rawgit.com/mrdoob/stats.js/master/build/stats.min.js'; document.head.appendChild(script); })()
    </script>
    <script type="module">
        import { Application } from "/script/app.js";
        import { Constants, BlockColor, BlockState } from "/script/dataTypes.js";

        let App;
        let ApplicationPromise = new Promise(function (resolve, reject) {
        App = new Application(document, document.querySelector('#Game'), resolve, reject);
        }.bind(this));

        ApplicationPromise.then(
        (res) => {
        //MainLoop.setUpdate(App.gameLoopService.tick.bind(App.gameLoopService)).setDraw(App.gameLoopService.updateView.bind(App.gameLoopService)).start();

        document.getElementById("GameTicksToHover").innerHTML = Constants.TICKS_FOR_HOVER;
        document.getElementById("GameTicksToFall").innerHTML = Constants.TICKS_FOR_FALL;
        document.getElementById("GameTicksToRemove").innerHTML = Constants.TICKS_FOR_REMOVING_BLOCKS;
        document.getElementById("GameTicksToHoverSwap").innerHTML = Constants.TICKS_FOR_HOVER_SWAP;

        });
        window.ApplyTicks = function ApplyTicks() {
        let ticks = Number.parseInt(document.getElementById("Ticks").value);

        for (let i = 0; i < ticks; i++) {
        App.gameLoopService.tick();
        App.gameLoopService.updateView();
        }
        UpdateDebugText();
        }

        function UpdateDebugText() {
        let logic = App.players[0].puzzle.logic;
        updateGame(logic.Active, logic.Ticks);
        updateRightBlock(logic.Blocks[logic.Selector.Row][logic.Selector.Col + 1]);
        updateLeftBlock(logic.Blocks[logic.Selector.Row][logic.Selector.Col]);
        App.gameLoopService.updateView();
        }
        function updateGame(active, ticks){
        document.getElementById("GameTicks").innerHTML  = ticks.Puzzle;
        document.getElementById("GameNewRow").innerHTML  = ticks.MoveBlocksUp;
        document.getElementById("GameSwap").innerHTML  = ticks.Swap;
        document.getElementById("GamePuzzleActive").innerHTML  = active.Puzzle;
        document.getElementById("GameHoverActive").innerHTML  = active.Hover;
        document.getElementById("GameSwapActive").innerHTML  = active.Swap;
        document.getElementById("GameBlocksRemovingActive").innerHTML = active.BlocksRemoving;
        document.getElementById("GameFallingActive").innerHTML = active.Falling;

        }
        function updateRightBlock(block){
        document.getElementById("RightBlockColor").innerHTML  = BlockColor[block.Color];
        document.getElementById("RightBlockState").innerHTML  = BlockState[block.State];
        document.getElementById("RightBlockTotalChain").innerHTML = block.TotalChain;
        document.getElementById("RightBlockTick").innerHTML = block.Tick;
        document.getElementById("RightBlockFallGroupTicks").innerHTML = block.FallGroupTicks;
        document.getElementById("RightBlockGroupId").innerHTML = block.groupId;

        }
        function updateLeftBlock(block){
        document.getElementById("LeftBlockColor").innerHTML = BlockColor[block.Color];
        document.getElementById("LeftBlockState").innerHTML = BlockState[block.State];
        document.getElementById("LeftBlockTotalChain").innerHTML = block.TotalChain;
        document.getElementById("LeftBlockTick").innerHTML = block.Tick;
        document.getElementById("LeftBlockFallGroupTicks").innerHTML = block.FallGroupTicks;
        document.getElementById("LeftBlockGroupId").innerHTML = block.groupId;
        }

        let g = UpdateDebugText.bind(this);
        window.document.addEventListener('keydown', (event) => {
        g();
        });

        function Zip(){
            var zip = new JSZip();

        for(let i = 0; i < App.players.length; i++){
            zip.file(App.players[i].playerName, JSON.stringify(App.players[i].puzzle.logic));
            zip.generateAsync({type:"blob"}).then(function(content) {
                saveAs(content, "Logs" +  Math.round((new Date()).getTime() / 1000) + ".zip");
            });
        }

        }

    </script>
</body>
</html>